function [edata] = exp_menu_prompt(edata)
% Display prompts to user to determine menu command

% Copyright 2009-2011 Mike Claffey (mclaffey[]ucsd.edu)
%
% 02/03/11 added results row
% 08/10/09 overhauled with changes to exp_menu
% 07/27/09 original version
    
%% now make sure there are menu options for the menu mode

    check_menu_choices()
    
%% prompt the user

    % turn off docking, so that the menu floats above other windows
    dock_by_default(0);
    edata.menu.command = menu_str('Which option?', edata.menu.menu_choices.(edata.menu.menu_mode));
    edata.menu.exit = false;
    
%% helper function to check the menu choices and provide default values for common modes

    function check_menu_choices
        default_choices = struct;
        default_choices.uninitialized = { ...
            'Initialize'; ...
            'Change Settings'; ...
            'Load Subject'; ...
            'Admin'; ...
            'Custom'; ...
            'Cancel'; ...
            };
        default_choices.main = { ...
            'Initialize'; ...
            'Change Settings'; ...
            'Manage Data'; ...
            'Practice'; ...
            'Run'; ...
            'Reset'; ...
            'Feedback'; ...
            'Load Subject'; ...
            'Analysis'; ...
            'Save Subject'; ...
            'Custom'; ...
            'Admin'; ...
            'Cancel'; ...
            };
        default_choices.settings = { ...
            'Inputs'; ...
            'Display'; ...
            'Sound'; ...
            'Update File Locations'; ...
            'TMS'; ...
            'fMRI'; ...
            'Cancel'; ...
            };
        default_choices.data = { ...
            'Add trials', ...
            'View data', ...
            'View blocks', ...
            'Delete trials', ...
            'Reinitialize', ...
            'Cancel' ...
            };        
        default_choices.admin = { ...
            'SVN Status'; ...
            'SVN Update'; ...
            'Create Zips'; ...
            'Create Help'; ...
            'Cancel'; ...
            };
        default_choices.analysis = { ...
            'Analyze subject'; ...
            'Command line report'; ...
            'Publish HTML report'; ...
            'Open HTML report'; ...
            'Create results row'; ...
            'Consolidate subjects'; ...
            'Cancel'; ...
            };
        
        % if the proper menu_choices field already exists
        if isfield(edata.menu.menu_choices, edata.menu.menu_mode)
            % if it is empty, throw an error
            if isempty(edata.menu.menu_choices.(edata.menu.menu_mode))
                error('The field edata.menu.menu_choices.%s is empty', edata.menu.menu_mode);
            end
            
        % if it doesn't exist, see if there are default values
        else
            if isfield(default_choices, edata.menu.menu_mode)
                edata.menu.menu_choices.(edata.menu.menu_mode) = default_choices.(edata.menu.menu_mode);
            else
                error('You are in menu mode %s, but there is no user-specified or default values', edata.menu.menu_mode);
            end
        end
    end
    
end